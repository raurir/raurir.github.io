"use strict";var _slicedToArray=function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return function(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")},isNode="undefined"!=typeof module;if(isNode)var rand=require("./rand.js"),dom=require("./dom.js"),colours=require("./colours.js");var log=function(){},aristotle=function(){var isSvg=0<arguments.length&&void 0!==arguments[0]&&arguments[0],r=rand.instance(),c=colours.instance(r),stage=isSvg?dom.svg("svg",{width:1,height:1}):dom.canvas(1,1),inner=isSvg&&dom.svg("g"),defs=isSvg&&dom.svg("defs"),angle60=2*Math.PI/3,initialSettings={time:{type:"Number",label:"Time",min:0,max:20,cur:10},edge:{type:"Boolean",label:"Fill Screen",cur:!0},background:{type:"Boolean",label:"Background",cur:!1}},settings=initialSettings,generationRequired=!0,gradientSets=[],lastSeed=void 0,progress=function(){},shapes=[],size=void 0,init=function(options){var seed=options.seed,targets=[];lastSeed!=seed&&(shapes=[],generationRequired=!0,gradientSets=[]),lastSeed=seed,options.progress&&(progress=options.progress),options.size&&(size=options.size),settings=JSON.parse(JSON.stringify(options.settings||initialSettings)),progress("settings:initialised",settings);var backgrounds=[];r.setSeed(seed);var backgroundColor=void 0,half=size/2,baseRotation=r.getNumber(0,1),triggerLimit=r.getNumber(.01,.5),radiusOuter=r.getNumber(.03,.1),outOfBounds=6*radiusOuter,minHeight=radiusOuter*Math.sin(angle60),pixelSize=Math.ceil(2*radiusOuter*size),lineWidth=.5<r.getNumber(0,1)?radiusOuter*r.getNumber(0,.3):0,gap=r.getNumber(0,.01),radiusInner=gap<radiusOuter?radiusOuter-gap:radiusOuter;isSvg?dom.setAttributes(stage,{width:size,height:size,viewBox:"0 0 "+size+" "+size}):stage.setSize(size,size);var xo=void 0,timeA=(new Date).getTime(),sample_w=300,sample_h=1,gradientSamplesCanvas=dom.canvas(sample_w,sample_h),createGradient=function(gradientSetIndex,gradientIndex){var start=r.getNumber(-100,0),end=r.getNumber(100,200),delta=end-start,stops=Array(2).fill().map(function(_,colourIndex){var offset=start+colourIndex/1*delta,stopColour=c.getRandomColour();return isSvg?'<stop offset="'+offset+'%" stop-color="'+stopColour+'"/>':{offset:offset,stopColour:stopColour}});if(isSvg)return'<linearGradient id="Gradient'+gradientIndex+'" x1="0" x2="1" y1="0" y2="0">'+stops.join("")+"</linearGradient>";var alreadyGenerated=gradientSets&&gradientSets[gradientSetIndex]&&gradientSets[gradientSetIndex][gradientIndex];if(alreadyGenerated)return alreadyGenerated;var gradientSampleCanvas=dom.canvas(sample_w,sample_h),gradientFill=gradientSampleCanvas.ctx.createLinearGradient(0,0,sample_w,sample_h);stops.forEach(function(_ref){var offset=_ref.offset,stopColour=_ref.stopColour;gradientFill.addColorStop((offset+100)/sample_w,stopColour)}),gradientSampleCanvas.ctx.fillStyle=gradientFill,gradientSampleCanvas.ctx.fillRect(0,0,sample_w,sample_h),gradientSamplesCanvas.ctx.drawImage(gradientSampleCanvas.canvas,0,11*gradientIndex);var gradientData=gradientSampleCanvas.ctx.getImageData(0,0,sample_w,sample_h).data,canvasStops=stops.map(function(_ref2,index){return{offset:index,stopColour:function(perc){var index=4*Math.floor(perc);return"rgb("+gradientData[index]+","+gradientData[index+1]+","+gradientData[index+2]}(_ref2.offset+100)}});return{start:start,end:end,stops:canvasStops}},currentGradient=void 0,currentGradientIndex=0;gradientSets=Array(3).fill().map(function(_,gradientSetIndex){return c.getRandomPalette(),backgrounds[gradientSetIndex]=c.getRandomColour(),Array(16).fill().map(function(_,gradientIndex){return createGradient(gradientSetIndex,gradientIndex)})});var pickNextGradient=function(){currentGradientIndex++,currentGradientIndex%=gradientSets.length,currentGradient=gradientSets[currentGradientIndex],backgroundColor=backgrounds[currentGradientIndex],isSvg&&(defs.innerHTML=currentGradient)};pickNextGradient();var timeB=(new Date).getTime();isSvg&&(stage.appendChild(defs),stage.appendChild(inner));var scaleGroup=function(group,scale){var rotate=group.rotate,x=group.x,y=group.y;isSvg&&group.setAttribute("transform","translate("+x*size+","+y*size+") rotate("+rotate+") scale("+scale+")")},calcTriangle=function(group,scale){group.scale=Math.min(scale,group.scale),targets.push(group)},row=0,col=0,iteration=0,timeC=(new Date).getTime(),gradientBox=!isSvg&&dom.canvas(pixelSize,pixelSize);generationRequired||shapes.forEach(function(){r.getInteger(0,1),r.getInteger(0,1)}),log({generationRequired:generationRequired});var _loop=function(){if(1e5<++iteration)throw new Error("bailing because too many iterations");var second=row%2==0,colIndex=col,large=2*radiusOuter;0===colIndex&&(xo=second?0:radiusOuter/-2);var x=(xo+=col%2==second?large:large/2)-outOfBounds,y=row*minHeight-outOfBounds;if(1+outOfBounds<x)return row++,col=0,"continue";if(1+outOfBounds<y)return row++,col=0,generationRequired=!1,"break";var group=isSvg?dom.svg("g"):dom.canvas(pixelSize,pixelSize);isSvg&&inner.appendChild(group);var path=Array(3).fill(0).map(function(_,j){var angle=((second+colIndex)%2?0:angle60/2)+j*angle60,tx=(radiusInner-lineWidth)*Math.cos(angle),ty=(radiusInner-lineWidth)*Math.sin(angle);return isSvg?(0===j?"M":"L")+tx*size+","+ty*size:{tx:tx,ty:ty}}),rotate=120*r.getInteger(0,2),gradientId=r.getInteger(0,15);if(isSvg){var triangle=dom.svg("path",{id:"triangle-"+row+"-"+col,d:path.concat("Z").join(" "),fill:"url(#Gradient"+gradientId+")"});group.appendChild(triangle)}else{var ctx=group.ctx,gradient=ctx.createLinearGradient(-pixelSize,0,pixelSize,0);currentGradient[gradientId].stops.forEach(function(_ref4){var offset=_ref4.offset,stopColour=_ref4.stopColour;gradient.addColorStop(offset,stopColour)}),gradientBox.ctx.fillStyle=gradient,gradientBox.ctx.fillRect(0,0,pixelSize,pixelSize),gradientBox.ctx.fill();var shapeBox=dom.canvas(pixelSize,pixelSize);shapeBox.ctx.translate(pixelSize/2,pixelSize/2),shapeBox.ctx.fillStyle="green",shapeBox.ctx.beginPath(),path.forEach(function(_ref5,index){var tx=_ref5.tx,ty=_ref5.ty,x=tx*size,y=ty*size;0===index?shapeBox.ctx.moveTo(x,y):shapeBox.ctx.lineTo(x,y)}),shapeBox.ctx.closePath(),shapeBox.ctx.lineCap="round",shapeBox.ctx.lineJoin="round",shapeBox.ctx.lineWidth=lineWidth*size,shapeBox.ctx.strokeStyle="green",shapeBox.ctx.fill(),shapeBox.ctx.stroke(),ctx.drawImage(gradientBox.canvas,0,0),ctx.globalCompositeOperation="destination-in",ctx.drawImage(shapeBox.canvas,0,0)}group.x=x,group.y=y,group.rotate=rotate,group.scale=1,group.timeout1=null,scaleGroup(group,1),col++,shapes.push(group)};_loop2:for(;generationRequired;){switch(_loop()){case"continue":continue;case"break":break _loop2}}shapes.forEach(function(group){return group.scale=1});var timeD=(new Date).getTime();log(timeB-timeA,timeC-timeB,timeD-timeC);var m0=void 0,m1=void 0,m2=void 0,m3=void 0,setModifier=function(){return{o:r.getNumber(-Math.PI,Math.PI),s:r.getNumber(.001,.002)}},setModifiers=function(){var _Array$fill$map,_Array$fill$map2;return _Array$fill$map=Array(4).fill().map(setModifier),_Array$fill$map2=_slicedToArray(_Array$fill$map,4),m0=_Array$fill$map2[0],m1=_Array$fill$map2[1],m2=_Array$fill$map2[2],m3=_Array$fill$map2[3],_Array$fill$map};setModifiers();var getTimeDelayFn=function(){var fadeStyle=r.getInteger(0,5);return function(group,offset){switch(fadeStyle){case 0:var dx=group.x-.5,dy=group.y-.5;return offset+Math.sqrt(dx*dx+dy*dy);case 1:return offset+2e3*Math.random();case 2:return offset+group.y;case 3:return offset+size-group.y;case 4:return offset+group.x;case 5:return offset+size-group.x}}},next=function(t){var delayHide=getTimeDelayFn();shapes.forEach(function(group){!function(group,delay){clearTimeout(group.timeout1),setTimeout(function(){return scaleGroup(group,0)},delay)}(group,delayHide(group,.1))}),setTimeout(function(){setModifiers(),pickNextGradient()},2500);var delayShow=getTimeDelayFn();setTimeout(function(){shapes.forEach(function(group){return function(group,delay){return setTimeout(function(){return scaleGroup(group,1)},delay)}(group,delayShow(group,0))})},5e3),setTimeout(function(){aristotleSet+=12e3,requestAnimationFrame(animate)},11500)},calculateTargets=function(t,amount){var i=.001*t,triggerDistance=.5*(Math.sin(Math.PI+i)+.6),fn=function(acc,_ref3,i){var o=_ref3.o,s=_ref3.s;return acc+Math[i%2?"sin":"cos"](o+t*s)},cx=.5*[m0,m1].reduce(fn,0)+.5,cy=.5*[m2,m3].reduce(fn,0)+.5;shapes.forEach(function(group){var dx=group.x-cx,dy=group.y-cy,d=Math.sqrt(dx*dx+dy*dy);triggerDistance<d&&d<triggerDistance+triggerLimit?isSvg?function(group){clearTimeout(group.timeout1),scaleGroup(group,0),group.timeout1=setTimeout(function(){return scaleGroup(group,1)},600)}(group):function(group,distance,amount){var halfD=triggerLimit/2,scale=Math.abs((distance-halfD)/halfD);calcTriangle(group,1-(1-scale)*amount)}(group,d-triggerDistance,amount):isSvg||calcTriangle(group,1)})},aristotleSet=0,animate=function animate(t){t<aristotleSet+15e3?(requestAnimationFrame(animate),calculateTargets(t)):(aristotleSet+=15e3,next())};isSvg?setTimeout(function(){return animate(0)},500):(calculateTargets(40*settings.time.cur+r.getInteger(0,1e7),r.getNumber(0,1)),calculateTargets(60*settings.time.cur+r.getInteger(0,1e7),r.getNumber(0,1)),targets=[],calculateTargets(80*settings.time.cur+r.getInteger(0,1e7),r.getNumber(0,1)),settings.background.cur?(stage.ctx.fillStyle=backgroundColor,stage.ctx.fillRect(0,0,size,size)):stage.ctx.clearRect(0,0,size,size),settings.time.cur||(targets=shapes.map(function(group){return Object.assign(group,{scale:1})})),targets.forEach(function(group){var canvas=group.canvas,rotate=group.rotate,scale=group.scale,x=group.x,y=group.y,dx=x-.5,dy=y-.5,h=Math.hypot(dx,dy);0==settings.edge.cur&&h>.2+r.getNumber(0,.3)-radiusOuter||(stage.ctx.save(),stage.ctx.translate(half,half),stage.ctx.rotate(baseRotation*Math.PI*2),stage.ctx.translate(-half,-half),stage.ctx.translate(x*size,y*size),stage.ctx.scale(scale,scale),stage.ctx.rotate(rotate/180*Math.PI),stage.ctx.translate(-pixelSize/2,-pixelSize/2),stage.ctx.drawImage(canvas,0,0),stage.ctx.restore())})),progress("render:complete",stage.canvas)};return{init:init,settings:settings,stage:isSvg?stage:stage.canvas,update:function(settings,seed){var then=(new Date).getTime();init({settings:settings,seed:seed});var now=(new Date).getTime();log("update time:",now-then)}}};isNode?module.exports=aristotle:"undefined"!=typeof define&&define("aristotle",function(){return aristotle});