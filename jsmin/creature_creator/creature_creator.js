"use strict";var _slicedToArray=function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return function(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var con=console,isNode="undefined"!=typeof module;if(isNode)var dom=require("./dom.js"),fs=require("fs");var creature_creator=function(){var bmp,ctx,stage=dom.element("div",{style:{position:"relative"}}),sw=400,sh=400,cx=.5*sw,horizon=sh-50,blockSize=10,creature={},inputs=[];function createLimb(options){var parent=options.parent;parent&&(options.parent=creature[parent],parent=options.parent);var div={};isNode||(div=dom.element("div",{style:{width:options.movement.length,height:blockSize,background:"rgba(255,0,0,0.5)",transformOrigin:"0 "+blockSize/2+"px",position:"absolute"}}),parent&&parent.div&&parent.div.appendChild(div));var keyframe=function(options){var parent=options.parent,translationX=options.movement.length,rotationStart=options.movement.baserot-options.movement.range,rotationEnd=options.movement.baserot+options.movement.range,divKeyframe=dom.element("div",{id:options.name,className:"limb"}),divJoint=dom.element("div",{id:options.name+"-joint",className:"joint"});parent?parent.divJoint.appendChild(divKeyframe):stage.appendChild(divKeyframe),divKeyframe.appendChild(divJoint);var transform=["0% {transform: rotate("+rotationStart+"rad);}","50% {transform: rotate("+rotationEnd+"rad);}","100% {transform: rotate("+rotationStart+"rad);}"],transformJoint=["0% {transform: translate("+translationX+"px,0px) rotate("+-rotationStart+"rad);}","50% {transform: translate("+translationX+"px,0px) rotate("+-rotationEnd+"rad);}","100% {transform: translate("+translationX+"px,0px) rotate("+-rotationStart+"rad);}"],delay=-2*(options.movement.offset+options.phase)/(2*Math.PI)-.63,animation=options.name+"-animation 2s "+delay+"s ease-in-out infinite;",animationOpposite=options.name+"-joint-animation 2s "+delay+"s ease-in-out infinite;";return{divKeyframe:divKeyframe,divJoint:divJoint,css:["#"+options.name+" {","width: "+options.movement.length+"px;","height: "+blockSize+"px;","animation: "+animation,"-webkit-animation: "+animation,"};","@keyframes "+options.name+"-animation {",transform.join(""),"}","@-webkit-keyframes "+options.name+"-animation {",transform.join(""),"}","#"+options.name+"-joint {","animation: "+animationOpposite,"-webkit-animation: "+animationOpposite,"};","@keyframes "+options.name+"-joint-animation {",transformJoint.join(""),"}","@-webkit-keyframes "+options.name+"-joint-animation {",transformJoint.join(""),"}"]}}(options),css=keyframe.css,divKeyframe=keyframe.divKeyframe,divJoint=keyframe.divJoint;return{name:options.name,options:options,div:div,css:css,divKeyframe:divKeyframe,divJoint:divJoint,pos:{sx:0,sy:0,ex:0,ey:0},calc:function(time){var osc=options.movement.baserot+Math.sin(time+options.movement.offset+options.phase)*options.movement.range;return this.position(osc),Math.max(this.pos.sy,this.pos.ey)},position:function(osc){this.osc=osc;var pos={sx:0,sy:0,ex:0+Math.sin(osc)*options.movement.length,ey:0+Math.cos(osc)*options.movement.length},translationX=0,rotation=osc;if(options.parent){var parent=options.parent;pos.sx+=parent.pos.ex,pos.sy+=parent.pos.ey,pos.ex+=parent.pos.ex,pos.ey+=parent.pos.ey,translationX=parent.options.movement.length,rotation=-parent.osc+osc}this.translationX=translationX,this.rotationRad=rotation,this.pos=pos},render:function(x,y){if(ctx.beginPath(),ctx.lineWidth=3,ctx.strokeStyle="#090",ctx.fillStyle="#0a0",ctx.moveTo(x+this.pos.sx,y+this.pos.sy),ctx.lineTo(x+this.pos.ex,y+this.pos.ey),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.drawCircle(x+this.pos.sx,y+this.pos.sy,blockSize/2),ctx.drawCircle(x+this.pos.ex,y+this.pos.ey,blockSize/2),ctx.closePath(),ctx.fill(),!isNode){var parent=options.parent,tx=parent?this.translationX:y,ty=parent?0:sw/2;div.style.transform="translate("+tx+"px,"+ty+"px)rotate("+this.rotationRad+"rad)"}}}}function render(t){for(var i in inputs)inputs[i].newValue&&inputs[i].newValue!=inputs[i].value&&(inputs[i].value-=.1*(inputs[i].value-inputs[i].newValue),inputs[i].dispatchEvent(new Event("change")));var time=isNode?t/50*Math.PI:t*Math.PI/1e3;ctx.fillStyle="#030",ctx.fillRect(0,0,sw,sh),ctx.fillStyle="#432",ctx.fillRect(cx-sw/2,horizon,sw,10);var max=0;for(var l in creature)max=Math.max(max,creature[l].calc(time));var canvas,frame,x=cx,y=horizon-max-blockSize/2;for(l in creature)creature[l].render(x,y);isNode?(canvas=bmp.canvas,frame=t,canvas.toBuffer(function(err,buf){if(err)con.log(err);else{var filename=__dirname+"/../export/running_man/runningman"+(10+frame)+".png";fs.writeFile(filename,buf,function(){con.log("writeFile",filename)})}}),t<49&&setTimeout(function(){render(++t)},50)):requestAnimationFrame(render)}return document.body.appendChild(stage),{stage:null,inner:null,resize:function(){},init:function(bitmap,context,settings,limbs){for(var c in bmp=bitmap,ctx=context,creature={},settings){var bit=settings[c];creature[bit.name]=createLimb(bit)}if(!isNode){var _style;!function(limbs){var editor=dom.element("div",{id:"editor",style:{color:"white","font-size":"10px",position:"absolute",top:-sh,left:.5*sw}}),output=dom.element("pre",{id:"output",style:{position:"absolute",top:0,left:200,margin:0,padding:4,background:"#0088",color:"#0ffd"}});function outputSettings(){output.innerHTML="var limbs = "+JSON.stringify(function roundFloats(x){return"number"==typeof x?parseFloat(x.toFixed(3)):Array.isArray(x)?x.map(roundFloats):x&&"object"===(void 0===x?"undefined":_typeof(x))?Object.fromEntries(Object.entries(x).map(function(_ref){var _ref2=_slicedToArray(_ref,2);return[_ref2[0],roundFloats(_ref2[1])]})):x}(limbs),null," ")+";"}function edit(parent,l,k){var multiplier=.001,max=2*Math.PI/multiplier;"length"===k&&(max=200,multiplier=1);var value=limbs[l][k],edit=dom.element("div",{style:{margin:0,display:"flex",alignItems:"center"}}),label=dom.element("div",{innerHTML:k+":",style:{color:"#fffa",width:40}}),input=dom.element("input",{value:value/multiplier,min:0,max:max,type:"range",style:{width:100}}),display=dom.element("input",{value:value,type:"number",style:{width:50}});return parent.appendChild(edit),edit.appendChild(label),edit.appendChild(input),edit.appendChild(display),input.addEventListener("change",function(e){var newValue=parseFloat(e.target.value)*multiplier;limbs[l][k]=newValue,display.value=newValue,outputSettings()}),input}for(var l in outputSettings(),limbs){var editLimb=dom.element("div",{style:{background:"#333","margin-bottom":5}});editor.appendChild(editLimb);var limbLabel=dom.element("div",{innerHTML:l,style:{fontWeight:"bold"}});for(var k in editLimb.appendChild(limbLabel),limbs[l])inputs.push(edit(editLimb,l,k))}function createButton(label,callback){var button=dom.element("button",{innerHTML:label});editor.appendChild(button),button.addEventListener("click",callback)}createButton("Random",function(e){for(var i in inputs)inputs[i].value=inputs[i].value*(.8+.4*Math.random()),inputs[i].dispatchEvent(new Event("change"))}),createButton("Morph",function(e){for(var i in inputs)inputs[i].newValue=inputs[i].value*(.8+.4*Math.random())}),stage.appendChild(editor),editor.appendChild(output)}(limbs);var divnested=dom.element("div",{id:"nested",style:(_style={position:"absolute",left:0,top:.75*-sh},_defineProperty(_style,"left",.25*-sw),_defineProperty(_style,"width",sh),_defineProperty(_style,"height",sw),_defineProperty(_style,"transform","rotate(-90deg)scale(-1,1) scale(0.5)"),_defineProperty(_style,"background","rgba(255,0,0,0.2)"),_style)});stage.appendChild(divnested),divnested.appendChild(creature.body.div);var divKeyframes=dom.element("div",{id:"keyframes",style:{position:"absolute",top:.25*-sh,left:.25*-sw,width:sh,height:sw,transform:"rotate(-90deg)scale(-1,1) scale(0.5)",background:"rgba(0,0,255,0.2)"}});stage.appendChild(divKeyframes),divKeyframes.appendChild(creature.body.divKeyframe);var styleSheet=document.createElement("style"),css=["body {","overflow: auto;","}","#body {","left: "+sh/2+"px;","top: "+sw/2+"px;","}",".limb {","background: rgba(0,0,200,0.8);","position: absolute;","transform-origin: center left;","transform-style: preserve-3d;","}",".joint {","background: rgba(0,0,255,0.9);","height: 0;","position: absolute;","transform-origin: center center;","width: 0;","}"];for(var l in creature)css=css.concat(creature[l].css);styleSheet.innerText=css.join(" "),document.head.appendChild(styleSheet)}render(0)},kill:function(){}}};isNode?module.exports=creature_creator():define("creature_creator",creature_creator);