"use strict";var tetris_cube=function tetris_cube(){var stage=document.createElement("div");var camera,scene,projector,renderer,holder;var mouse={x:0,y:0};var sw=window.innerWidth,sh=window.innerHeight;var theta=0,gamma=0;var dim=4;var size=40;var cubes=[];var groups=[];var available=[];function cube(){var material=new THREE.MeshLambertMaterial({color:0});var geometry=new THREE.BoxGeometry(size,size,size);return new THREE.Mesh(geometry,material)}function init(){scene=new THREE.Scene;camera=new THREE.PerspectiveCamera(70,sw/sh,1,1e4);camera.position.set(0,100,500);scene.add(camera);var light=new THREE.DirectionalLight(16777215,2);light.position.set(1,1,1).normalize();scene.add(light);var light=new THREE.DirectionalLight(16711935,2);light.position.set(-1,0,0).normalize();scene.add(light);renderer=new THREE.WebGLRenderer;renderer.setSize(sw,sh);holder=new THREE.Group;scene.add(holder);function p(index){return(index-dim/2+.5)*size}function getPositionFromIndex(index){var x=index%dim;var y=Math.floor(index/dim)%dim;var z=Math.floor(index/(dim*dim));return{x:x,y:y,z:z}}function getIndexFromPosition(_ref){var x=_ref.x,y=_ref.y,z=_ref.z;return x+y*dim+z*dim*dim}for(var i=0;i<dim*dim*dim;i++){var c=cube();var _getPositionFromIndex=getPositionFromIndex(i),x=_getPositionFromIndex.x,y=_getPositionFromIndex.y,z=_getPositionFromIndex.z;available.push(i);c.position.set(p(x),p(y),p(z));c.groupId=0;cubes.push(c);holder.add(c)}var globalGroupId=1;var loners=[];var MODE_GROUP_EXPAND="MODE_GROUP_EXPAND";var MODE_LONER_UNITE="MODE_LONER_UNITE";var checkMode=MODE_GROUP_EXPAND;function checkNeighbours(sourceIndex){function checkNeighbour(targetPosition){var targetIndex=getIndexFromPosition(targetPosition);if(checkMode===MODE_GROUP_EXPAND&&cubes[targetIndex].groupId===0){setGroup(targetIndex,cubes[sourceIndex].groupId);count++}else if(checkMode===MODE_LONER_UNITE&&cubes[targetIndex].groupId>0){setGroup(sourceIndex,cubes[targetIndex].groupId);count++}else{}}var _getPositionFromIndex2=getPositionFromIndex(sourceIndex),x=_getPositionFromIndex2.x,y=_getPositionFromIndex2.y,z=_getPositionFromIndex2.z;var count=0;var queue=[];function queueCheck(pos){queue.push(pos)}if(x===0){queueCheck({x:x+1,y:y,z:z})}else if(x===dim-1){queueCheck({x:x-1,y:y,z:z})}else{queueCheck({x:x-1,y:y,z:z});queueCheck({x:x+1,y:y,z:z})}if(y===0){queueCheck({x:x,y:y+1,z:z})}else if(y===dim-1){queueCheck({x:x,y:y-1,z:z})}else{queueCheck({x:x,y:y-1,z:z});queueCheck({x:x,y:y+1,z:z})}if(z===0){queueCheck({x:x,y:y,z:z+1})}else if(z===dim-1){queueCheck({x:x,y:y,z:z-1})}else{queueCheck({x:x,y:y,z:z-1});queueCheck({x:x,y:y,z:z+1})}rand.shuffle(queue);for(var q=0;q<queue.length;q++){checkNeighbour(queue[q])}if(count===0){loners.push(sourceIndex)}if(checkMode===MODE_GROUP_EXPAND)nextGroup()}function nextGroup(){var availableIndex=Math.floor(available.length*Math.random());if(available.length){availableIndex=available[availableIndex];globalGroupId++;setGroup(availableIndex,globalGroupId);checkNeighbours(availableIndex)}else{con.log("all done...",groups);var pos=0;setTimeout(function(){groups.forEach(function(group,groupIndex){var cols=4;var average={x:(-cols/2+groupIndex%cols)*size*4,y:Math.floor(-1+groupIndex/cols)*size*4,z:0};group.forEach(function(mesh){TweenMax.to(mesh.position,.5,{x:mesh.position.x+average.x,y:mesh.position.y+average.y,z:mesh.position.z+average.z,delay:groupIndex*.1})})})},1700)}}function setGroup(targetIndex,groupId){var maxSize=checkMode===MODE_LONER_UNITE?6:4;if(!groups[groupId])groups[groupId]=[];if(groups[groupId].length===maxSize){return}var c=cubes[targetIndex];groups[groupId].push(c);c.groupId=groupId;var availableIndex=available.indexOf(targetIndex);available.splice(availableIndex,1)}setGroup(0,globalGroupId);checkNeighbours(0);con.log(loners);rand.shuffle(loners);con.log(loners);checkMode=MODE_LONER_UNITE;for(i=0;i<loners.length;i++){checkNeighbours(loners[i])}for(i=0;i<cubes.length;i++){var c=cubes[i];var r=c.groupId*20%255;var g=100;var b=100;var col=r<<16|g<<8|b;c.material.color.setHex(col)}stage.appendChild(renderer.domElement);document.addEventListener("mousemove",onDocumentMouseMove,false);render();animate()}function onDocumentMouseMove(event){event.preventDefault();mouse.x=event.clientX/sw*2-1;mouse.y=-(event.clientY/sh)*2+1}function render(){var camRadius=500;gamma+=mouse.y*4;holder.rotation.x=gamma*.1;holder.rotation.y=theta*.1;camera.lookAt(scene.position);renderer.render(scene,camera)}function animate(){requestAnimationFrame(animate);render()}var experiment={stage:stage,init:init};return experiment};define("tetris_cube",tetris_cube);