"use strict";var con=console;var isNode=typeof module!=="undefined";if(isNode){var rand=require("./rand.js");var dom=require("./dom.js");var colours=require("./colours.js")}var hexagon_tile=function hexagon_tile(){var spreadSeed;var spreadGradient=.1;function getJitter(){spreadSeed+=1.89127398;return(Math.sin(spreadSeed)+Math.cos(spreadSeed*2.12387891))/2*.1}var size=100,vector=false,sw=size,sh=size,angle60=2*Math.PI/6,radiusOuter,strokeSize,radiusInner,smoothSize,randomHexes,stage,inner,hexagons,hexs,batchSize=1e3,batches,currentBatch=0;var stage,inner;var settings={spread:{type:"Number",label:"Spread",min:1,max:10,cur:10},background:{type:"Boolean",label:"Background",cur:true}};if(vector){stage=dom.svg("svg",{width:sw,height:sh});inner=dom.svg("g");stage.appendChild(inner)}else{stage=dom.canvas(sw,sh)}function init(options){spreadSeed=rand.getSeed();spreadGradient=rand.getLastRandom()*.5;size=options.size;sw=options.sw||size;sh=options.sh||size;stage.setSize(sw,sh);settings.spread.cur=10;settings.background.cur=true;if(options.settings){settings=options.settings}progress("settings:initialised",settings);var palette=colours.getRandomPalette();var backgroundColor=colours.getRandomColour();radiusOuter=(5+rand.random()*25)/1e3;strokeSize=rand.random()*rand.random()*rand.random()*radiusOuter;radiusInner=radiusOuter-strokeSize+strokeSize*.01;smoothSize=.01+rand.random()*10;if(vector){while(inner.firstChild){inner.removeChild(inner.firstChild)}stage.setAttribute("style","background-color:"+backgroundColor)}else{if(settings.background.cur){stage.ctx.fillStyle=backgroundColor;stage.ctx.fillRect(0,0,size,size)}}var path=[],points=[];for(var i=0;i<6;i++){var angle=i*angle60,x=radiusInner*Math.cos(angle),y=radiusInner*Math.sin(angle);path[i]=(i===0?"M":"L")+x+","+y;points[i]={x:x,y:y}}path.push("Z");var minHeight=radiusOuter*Math.sin(angle60);var cols=Math.ceil(1/radiusOuter/3)+1;var rows=Math.ceil(1/minHeight)+1;hexagons=cols*rows;hexs=[];for(var i=0;i<hexagons;i++){var row=Math.floor(i/cols);var second=row%2==0;var col=i%cols+(second?.5:0);var x=col*radiusOuter*3;var y=row*minHeight;var hex;if(vector){var group=dom.svg("g");group.setAttribute("transform","translate("+x+","+y+")");inner.appendChild(group);hex=dom.svg("path",{d:path.join(" ")});group.appendChild(hex)}else{hex=points}hexs[i]={index:i,hex:hex,x:x,y:y,colour:null,rendered:false}}randomHexes=rand.shuffle(hexs.slice());render()}function batch(){var shouldRender=settings.spread.cur/settings.spread.max*10;con.log("shouldRender",shouldRender);var maxRender=hexagons;var loopStart=currentBatch*batchSize,loopEnd=loopStart+batchSize;if(loopEnd>maxRender)loopEnd=maxRender;for(var h=loopStart;h<loopEnd;h++){var index=randomHexes[h].index;var item=hexs[index];var close=[];for(var i=0;i<hexagons;i++){if(i!=h){var otherItem=randomHexes[i];if(otherItem.rendered){var dx=item.x-otherItem.x,dy=item.y-otherItem.y,d=Math.sqrt(dx*dx+dy*dy);if(d<radiusOuter*smoothSize){close.push(otherItem.colour)}}}}var colour;if(close.length>0){colour=colours.mixColours(close)}else{colour=colours.getNextColour()}if(vector){item.hex.setAttribute("style","fill:"+colour)}else{var dx=item.x-.5+getJitter(),dy=item.y-.5+getJitter();var distanceFromCenter=Math.round(Math.sqrt(dx*dx+dy*dy)*10);if(distanceFromCenter<shouldRender){stage.ctx.fillStyle=colour;stage.ctx.beginPath();for(var i=0;i<6;i++){var x=(item.x+item.hex[i].x)*size,y=(item.y+item.hex[i].y)*size;if(i===0){stage.ctx.moveTo(x,y)}else{stage.ctx.lineTo(x,y)}}stage.ctx.closePath();stage.ctx.fill()}}hexs[index].rendered=true;hexs[index].colour=colour}currentBatch++;if(currentBatch==batches){progress("render:complete",experiment.stage)}else{progress("render:progress",currentBatch/batches);setTimeout(batch,25)}}function render(){batches=Math.ceil(hexagons/batchSize);currentBatch=0;batch()}function update(settings){init({size:size,settings:settings})}var experiment={init:init,render:render,settings:settings,stage:vector?stage:stage.canvas,update:update};return experiment};if(isNode){module.exports=hexagon_tile()}else{define("hexagon_tile",hexagon_tile)}