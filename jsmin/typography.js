"use strict";var isNode="undefined"!=typeof module;if(isNode)var rand=require("./rand.js"),dom=require("./dom.js"),colours=require("./colours.js");var typography=function(){return function(){var progress,size,sw,sh,block,r=rand.instance(),c=colours.instance(r,"v1"),settings={boxes:{label:"Boxes",min:2,max:64,cur:4,type:"Number"},background:{type:"Boolean",label:"Background",cur:!1}},bmp=dom.canvas(100,100),ctx=bmp.ctx,rows=4,cols=4;function typoInteger(min,max){return Math.round(r.getNumber(min,max))}var numerals="0";function drawBlock(x,y){if(ctx.save(),ctx.translate(x*block,y*block),.6<r.random()){var w=typoInteger(1,3),h=typoInteger(1,3);ctx.fillStyle=c.getRandomColour(),ctx.fillRect(0,0,block*w,block*h)}try{.8<r.random()&&(border=.1*block,ctx.fillStyle=c.getRandomColour(),ctx.fillRect(border,border,block-2*border,block-2*border))}catch(err){}var border,angle,xo,yo,fontSize;try{.9<r.random()&&function(){for(var divs=Math.pow(2,Math.ceil(3*r.random())),size=block/divs,i=0;i<divs*divs;i++){var x=i%divs,y=Math.floor(i/divs);ctx.fillStyle=c.getRandomColour(),ctx.fillRect(x*size,y*size,size,size)}}()}catch(err){}try{.9<r.random()&&function(){var rotation=Math.round(4*r.random())/4*Math.PI,rowSize=Math.round((2+Math.floor(8*r.random()))*size/1e3),patternColoured=dom.canvas(rowSize,2*rowSize);ctx.save(),ctx.beginPath(),ctx.rect(0,0,block,block),ctx.rotate(rotation),patternColoured.ctx.fillStyle=c.getNextColour();for(var py=0;py<block/rowSize*4;py++)patternColoured.ctx.fillRect(0,py*rowSize*2,block*rowSize,rowSize);ctx.fillStyle=ctx.createPattern(patternColoured.canvas,"repeat"),ctx.fill(),ctx.restore()}()}catch(err){}try{.8<r.random()&&function(){ctx.save();var angle=Math.floor(4*r.random())/4;ctx.rotate(angle*Math.PI*2);var majors=Math.pow(2,typoInteger(1,4)),minors=typoInteger(1,4),majorSize=typoInteger(5,10)*size/400,minorSize=majorSize*r.getNumber(.2,.8);ctx.fillStyle=c.getRandomColour();for(var width=1*size/300,m=0;m<majors;m++){var x=m/majors*block;ctx.fillRect(x,0,width,majorSize);for(var n=0;n<minors;n++){var xn=x+n/minors*block/majors;ctx.fillRect(xn,0,width,minorSize)}}ctx.restore()}()}catch(err){}try{.4<r.random()&&(angle=Math.floor(4*r.random())/4,xo=r.random()*block,yo=r.random()*block,fontSize=Math.round(Math.pow(2,2+6*r.random())*size/400),ctx.rotate(angle*Math.PI*2),ctx.translate(xo,yo),ctx.font=fontSize+"px Helvetica",ctx.fillStyle=c.getRandomColour(),ctx.fillText(function(){var strings=["Typography",numerals],str=strings[Math.floor(r.random()*strings.length)],ss=Math.round(r.random()*str.length),se=ss+Math.round(r.random()*(str.length-ss));switch(str=str.substr(ss,se),Math.floor(3*r.random())){case 0:str=str.toLowerCase();break;case 1:str=str.toUpperCase()}return str}(),0,0))}catch(err){}ctx.restore()}function init(options){progress=options.progress||function(){},r.setSeed(options.seed),size=options.size,sh=sw=size,settings.background.cur=!1,settings.boxes.cur=4,options.settings&&(settings=options.settings),progress("settings:initialised",settings),cols=settings.boxes.cur,rows=settings.boxes.cur,block=Math.ceil(1/cols*size),bmp.setSize(sw,sh),ctx.clearRect(0,0,sw,sh),c.getRandomPalette(),c.setPaletteRange(3),render()}function render(){settings.background.cur&&(ctx.fillStyle=c.getCurrentColour(),ctx.fillRect(0,0,sw,sh)),function renderBatch(batch){var total=rows*cols;var x=batch%cols;var y=Math.floor(batch/cols);drawBlock(x,y);batch<total?(progress("render:progress",batch/total),setTimeout(function(){renderBatch(batch+1)},5)):progress("render:complete",bmp.canvas)}(0)}return{stage:bmp.canvas,init:init,render:render,settings:settings,update:function(settings,seed){init({progress:progress,size:size,settings:settings,seed:seed})}}}};isNode?module.exports=typography():define("typography",typography);